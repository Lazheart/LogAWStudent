# src/logawstudent/cli.py
import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.text import Text
from rich import box
from .utils import set_env, unset_env, load_env, clear_env, update_env, get_credentials_status, get_env_file
from .core import launch_lab

console = Console()

app = typer.Typer(
    help="CLI para automatizar login y labs de AWS Academy",
    no_args_is_help=False,
    add_completion=False
)

@app.callback(invoke_without_command=True)
def main(ctx: typer.Context):
    """LogAWStudent - CLI para automatizar login y labs de AWS Academy"""
    if ctx.invoked_subcommand is None:
        show_main_info()

def show_credentials_status():
    """Muestra el estado de las credenciales con formato elegante."""
    status = get_credentials_status()
    
    # Crear tabla para mostrar el estado
    table = Table(show_header=True, header_style="bold blue", box=box.ROUNDED)
    table.add_column("Credencial", style="cyan", width=12)
    table.add_column("Estado", justify="center", width=8)
    table.add_column("Valor", style="dim", width=30)
    
    for key, info in status.items():
        if info['exists']:
            # Mostrar solo los primeros y √∫ltimos caracteres para seguridad
            value = info['value']
            if key == "PASSWORD":
                display_value = "*" * len(value) if value else "No configurado"
            elif key == "LAB_URL":
                # Para URLs, mostrar m√°s caracteres para que sea √∫til
                if len(value) > 20:
                    display_value = value[:10] + "..." + value[-10:]
                else:
                    display_value = value
            else:
                display_value = value[:3] + "..." + value[-3:] if len(value) > 6 else value
            table.add_row(key, "‚úÖ", display_value)
        else:
            table.add_row(key, "‚ùå", "No configurado")
    
    # Crear panel con la tabla
    panel_content = table
    console.print(Panel(panel_content, title="üìä Estado de las Credenciales", border_style="blue"))
    
    # Mostrar mensaje de estado
    all_configured = all(info['exists'] for info in status.values())
    if all_configured:
        console.print(Panel("üöÄ Todas las credenciales est√°n configuradas. Puedes usar 'awstudent start'", 
                           title="‚úÖ Listo", border_style="green"))
    else:
        missing = [k for k, v in status.items() if not v['exists']]
        console.print(Panel(f"‚ö†Ô∏è  Faltan credenciales: {', '.join(missing)}\n"
                           f"Usa 'awstudent login' y 'awstudent url --set' para configurar", 
                           title="‚ö†Ô∏è  Configuraci√≥n Incompleta", border_style="yellow"))

def show_main_info():
    """Muestra informaci√≥n principal del proyecto cuando se ejecuta solo 'awstudent'."""
    # Informaci√≥n del proyecto
    console.print(Panel(
        "üöÄ CLI para automatizar login y labs de AWS Academy\n\n"
        "Este proyecto automatiza el inicio de sesi√≥n en AWS Academy y el lanzamiento\n"
        "de un laboratorio a trav√©s de Selenium y Python. Es √∫til para estudiantes de\n"
        "AWS Academy que necesitan realizar este proceso repetidamente.\n\n"
        "üì¶ Caracter√≠sticas:\n"
        "‚Ä¢ Login autom√°tico en AWS Academy\n"
        "‚Ä¢ Lanzamiento autom√°tico de laboratorios\n"
        "‚Ä¢ Gesti√≥n de credenciales segura\n"
        "‚Ä¢ Interfaz CLI intuitiva\n"
        "‚Ä¢ Modo headless para mayor eficiencia",
        title="üéØ LogAWStudent",
        border_style="blue"
    ))
    
    # Informaci√≥n del autor
    console.print(Panel(
        "üë®‚Äçüíª Autor: Lazheart\n"
        "üîó Repositorio: https://github.com/Lazheart/LogAWStudent\n"
        "‚≠ê Estrellas: 4\n"
        "üç¥ Forks: 0\n"
        "üìù Licencia: Open Source",
        title="üë§ Informaci√≥n del Proyecto",
        border_style="green"
    ))
    
    # Comandos disponibles
    console.print(Panel(
        "üìã Comandos disponibles:\n\n"
        "‚Ä¢ awstudent login     - Gestiona credenciales de login\n"
        "‚Ä¢ awstudent url       - Configura URL del laboratorio\n"
        "‚Ä¢ awstudent start     - Inicia el laboratorio autom√°ticamente\n"
        "‚Ä¢ awstudent status    - Muestra estado de credenciales\n"
        "‚Ä¢ awstudent clean     - Limpia credenciales espec√≠ficas\n\n"
        "üßπ Opciones de limpieza:\n"
        "‚Ä¢ awstudent login --clean email    - Elimina solo el email\n"
        "‚Ä¢ awstudent login --clean password - Elimina solo la contrase√±a\n"
        "‚Ä¢ awstudent login --clean all      - Elimina email y contrase√±a\n"
        "‚Ä¢ awstudent url --clean            - Elimina la URL del laboratorio\n\n"
        "üí° Usa 'awstudent <comando> --help' para m√°s informaci√≥n",
        title="üìö Comandos Disponibles",
        border_style="yellow"
    ))
    
    # Estado actual
    show_credentials_status()

@app.command()
def login(
    status: bool = typer.Option(False, "--status", help="Muestra el estado de las credenciales"),
    update: bool = typer.Option(False, "--update", help="Actualiza credenciales existentes"),
    force: bool = typer.Option(False, "--force", help="Fuerza la sobrescritura sin preguntar"),
    delete: bool = typer.Option(False, "--delete", help="Elimina las credenciales de login"),
    clean: str = typer.Option(None, "--clean", help="Limpia credenciales espec√≠ficas: 'email', 'password', o 'all'")
):
    """Guarda o actualiza credenciales (email y password) en .env"""
    if status:
        show_credentials_status()
        return
    
    if clean:
        if clean == "email":
            unset_env("EMAIL")
            console.print(Panel("üßπ Email eliminado.", 
                               title="üßπ Limpieza", border_style="yellow"))
        elif clean == "password":
            unset_env("PASSWORD")
            console.print(Panel("üßπ Password eliminada.", 
                               title="üßπ Limpieza", border_style="yellow"))
        elif clean == "all":
            unset_env("EMAIL")
            unset_env("PASSWORD")
            console.print(Panel("üßπ Todas las credenciales de login eliminadas.", 
                               title="üßπ Limpieza Completa", border_style="yellow"))
        else:
            console.print(Panel("‚ùå Opci√≥n inv√°lida para --clean. Usa: 'email', 'password', o 'all'", 
                               title="‚ùå Error", border_style="red"))
        return
    
    if delete:
        unset_env("EMAIL")
        unset_env("PASSWORD")
        console.print(Panel("üßπ Credenciales de login eliminadas.", 
                           title="üßπ Eliminado", border_style="yellow"))
        return
    
    if update:
        try:
            email = typer.prompt("Ingrese su nuevo EMAIL")
            password = typer.prompt("Ingrese su nueva PASSWORD", hide_input=True)
            update_env("EMAIL", email)
            update_env("PASSWORD", password)
            console.print(Panel("‚úÖ Credenciales actualizadas exitosamente.", 
                               title="‚úÖ √âxito", border_style="green"))
        except ValueError as e:
            console.print(Panel(f"‚ùå {e}", title="‚ùå Error", border_style="red"))
    else:
        # Verificar si ya existen credenciales
        existing_creds = load_env()
        has_existing = any(existing_creds.get(key) for key in ["EMAIL", "PASSWORD"])
        
        if has_existing and not force:
            console.print(Panel("‚ö†Ô∏è  Ya existen credenciales guardadas.", 
                               title="‚ö†Ô∏è  Credenciales Existentes", border_style="yellow"))
            overwrite = typer.confirm("¬øDeseas sobrescribir las credenciales existentes?")
            if not overwrite:
                console.print("Operaci√≥n cancelada.", style="yellow")
                return
        
        email = typer.prompt("Ingrese su EMAIL")
        password = typer.prompt("Ingrese su PASSWORD", hide_input=True)
        set_env("EMAIL", email)
        set_env("PASSWORD", password)
        console.print(Panel("‚úÖ Credenciales guardadas exitosamente.", 
                           title="‚úÖ √âxito", border_style="green"))

@app.command()
def url(
    set: bool = typer.Option(False, "--set", help="Establece la URL del laboratorio"),
    unset: bool = typer.Option(False, "--unset", help="[DEPRECATED] Usa --delete en su lugar"),
    update: bool = typer.Option(False, "--update", help="Actualiza la URL del laboratorio"),
    delete: bool = typer.Option(False, "--delete", help="Elimina la URL del laboratorio"),
    clean: bool = typer.Option(False, "--clean", help="Limpia la URL del laboratorio")
):
    """Configura, actualiza o elimina la URL del laboratorio."""
    if clean:
        unset_env("LAB_URL")
        console.print(Panel("üßπ URL del laboratorio eliminada.", 
                           title="üßπ Limpieza", border_style="yellow"))
        return
    
    if set:
        lab_url = typer.prompt("Ingrese la URL del LAB")
        set_env("LAB_URL", lab_url)
        console.print(Panel("‚úÖ URL del laboratorio guardada.", 
                           title="‚úÖ √âxito", border_style="green"))
    elif update:
        try:
            lab_url = typer.prompt("Ingrese la nueva URL del LAB")
            update_env("LAB_URL", lab_url)
            console.print(Panel("‚úÖ URL del laboratorio actualizada.", 
                               title="‚úÖ √âxito", border_style="green"))
        except ValueError as e:
            console.print(Panel(f"‚ùå {e}", title="‚ùå Error", border_style="red"))
    elif unset or delete:
        if unset:
            console.print(Panel("‚ö†Ô∏è  --unset est√° deprecado. Usa --delete en su lugar.", 
                               title="‚ö†Ô∏è  Deprecado", border_style="yellow"))
        unset_env("LAB_URL")
        console.print(Panel("üßπ URL del laboratorio eliminada.", 
                           title="üßπ Eliminado", border_style="yellow"))
    else:
        data = load_env()
        current_url = data.get('LAB_URL')
        if current_url and current_url != 'No configurada':
            # Mostrar solo parte de la URL por seguridad
            display_url = current_url[:30] + "..." if len(current_url) > 30 else current_url
            console.print(Panel(f"üîó URL actual: {display_url}", 
                               title="üîó URL del Laboratorio", border_style="blue"))
        else:
            console.print(Panel("üîó URL actual: No configurada", 
                               title="üîó URL del Laboratorio", border_style="blue"))


@app.command()
def start(
    force: bool = typer.Option(False, "--force", help="Fuerza el inicio sin verificar credenciales"),
    status: bool = typer.Option(False, "--status", help="Muestra el estado antes de iniciar")
):
    """Inicia el laboratorio autom√°ticamente."""
    if status:
        show_credentials_status()
        return
    
    # Verificar credenciales antes de iniciar
    try:
        from .utils import validate_credentials
        validate_credentials()
        console.print(Panel("üöÄ Iniciando laboratorio...", 
                           title="üöÄ Iniciando", border_style="blue"))
        launch_lab()
    except ValueError as e:
        if force:
            console.print(Panel("‚ö†Ô∏è  Iniciando sin credenciales completas...", 
                               title="‚ö†Ô∏è  Modo Forzado", border_style="yellow"))
            launch_lab()
        else:
            console.print(Panel(f"‚ùå {e}\nüí° Usa 'awstudent login --status' para ver qu√© credenciales faltan", 
                               title="‚ùå Error", border_style="red"))

@app.command()
def status(
    verbose: bool = typer.Option(False, "--verbose", help="Muestra informaci√≥n detallada"),
    force: bool = typer.Option(False, "--force", help="Fuerza la actualizaci√≥n del estado")
):
    """Muestra el estado de todas las credenciales."""
    if verbose:
        # Mostrar informaci√≥n adicional
        env_file = get_env_file()
        console.print(Panel(f"üìÅ Archivo de configuraci√≥n: {env_file}", 
                           title="üìÅ Informaci√≥n del Sistema", border_style="blue"))
    
    show_credentials_status()

@app.command()
def clean(
    all: bool = typer.Option(False, "--all", help="Elimina todas las credenciales"),
    login: bool = typer.Option(False, "--login", help="Elimina solo las credenciales de login"),
    url: bool = typer.Option(False, "--url", help="Elimina solo la URL del laboratorio"),
    force: bool = typer.Option(False, "--force", help="Fuerza la limpieza sin confirmar")
):
    """Limpia credenciales espec√≠ficas o todas las credenciales."""
    if all:
        if not force:
            confirm = typer.confirm("¬øEst√°s seguro de que quieres eliminar TODAS las credenciales?")
            if not confirm:
                console.print("Operaci√≥n cancelada.", style="yellow")
                return
        clear_env()
        console.print(Panel("üßπ Todas las credenciales han sido eliminadas.", 
                           title="üßπ Limpieza Completa", border_style="yellow"))
    elif login:
        unset_env("EMAIL")
        unset_env("PASSWORD")
        console.print(Panel("üßπ Credenciales de login eliminadas.", 
                           title="üßπ Limpieza de Login", border_style="yellow"))
    elif url:
        unset_env("LAB_URL")
        console.print(Panel("üßπ URL del laboratorio eliminada.", 
                           title="üßπ Limpieza de URL", border_style="yellow"))
    else:
        # Mostrar ayuda si no se especifica qu√© limpiar
        console.print(Panel("üí° Especifica qu√© quieres limpiar:\n"
                           "‚Ä¢ awstudent clean --all: Elimina todas las credenciales\n"
                           "‚Ä¢ awstudent clean --login: Elimina solo credenciales de login\n"
                           "‚Ä¢ awstudent clean --url: Elimina solo la URL del laboratorio", 
                           title="üßπ Comando Clean", border_style="blue"))

if __name__ == "__main__":
    app()
